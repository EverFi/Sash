
div#badge-show
  div.row
    div.span3
      img(src=badge.imageUrl).display-badge-image
      img(src=badge.grayImageUrl).display-badge-image
    div.span6
      h1(style="margin-top:30px;") #{badge.name}
      img(src=badge.miniImageUrl).display-badge-image
      img(src=badge.miniGrayImageUrl).display-badge-image
  div.row
    div.span5
      table.table.table.striped.table-hover.table-condensed.badge-details
        if badge.description
          tr
            td Description
            td #{badge.description}
        tr
          td Criteria
          td #{badge.criteria}
        tr
          td Facebook Share Text
          td #{badge.facebook_text}
        tr
          td Twitter Share Text
          td #{badge.twitter_text}
        if badge.link
          tr
            td Share Link
            td #{badge.link}
        if badge.version
          tr
            td Version
            td #{badge.version}
        tr
          td Issuer
          if issuer.origin
            td #{issuer.name} - 
              a(href="#{issuer.origin}") (#{issuer.origin})
          else
            td #{issuer.name}
        if badge.tags.length > 0
          tr
            td Tags
            td
              each tag in badge.tags
                span.tag
                  = tag
        tr
          td Issue URL
          td #{badge.slugUrl}
        tr
          td Slug
          td #{badge.slug}
    div.span3
      select.select-user(disabled="disabled")
        option(value="") Loading Users...
      br
      button(disabled="disabled").user-action-btn.btn.issue.btn-success Issue Badge
      button(disabled="disabled").user-action-btn.btn.revoke.btn-warning(style="margin-left:15px;") Revoke Badge

  div.row
    button.btn.btn-link
      a(href="/badges/#{badge.slug}/edit") Edit Badge
    form.delete-form(action="/badges/#{badge.slug}", method='post', class="delete", data-confirm='Are you sure you want to delete this badge?')
      input(type="hidden", value="delete", name="_method")
      button.btn.btn-danger.delete-badge(style="margin-left:15px; margin-top:5px;") Delete

  script
    $.get('/users/#{badge.issuer_id}/all', function(users){
      $('.select-user').find('option').html('Choose A User');
      $.each(users, function (index, user){
        var opt = $('<option></option>');
        $(opt)
          .html( user.username )
          .attr( 'value', user.username );
        $('.select-user')
          .append( opt )
          .removeAttr( 'disabled' );
      });
    });

    $('.issue').click(function(){
      var username = $('.select-user').val();
      if ( username ) {
        $.ajax({
          type: "POST",
          url: '/badges/issue/#{badge.slug}',
          data: {username:username},
          success: function(data){
            var msg;
            if ( data.earned === true ) {
              msg = "'#{badge.name}' has been issued to " + username;
              alertify.alert( msg );
            } else {
              msg = data.message;
              alertify.log( msg, 'error' );
            }
            
          },
        });
      }
    });

    $('.select-user').on('change', function(){
      var username = $(this).val();
      if ( username ) {
        $('.user-action-btn').removeAttr('disabled');
      } else {
        $('.user-action-btn').attr('disabled', 'disabled');
      }
    });

    $('.revoke').click(function(){
      var username = $('.select-user').val();
      if ( username ) {
        $.ajax({
          type: "POST",
          url: '/badges/revoke/#{badge._id}',
          data: {username:username},
          success: function(data){
            if ( data.revoked ) {
              alertify.alert( "Revoked '#{badge.name}' from user " + username );
            } else {
              alertify.error( "Could not revoke '#{badge.name}' from " + username );
            }
          }
        });
      }
    });

    $('.delete-badge').click(function(e){
      e.preventDefault();
      var msg = $('.delete-form').data('confirm');
      alertify.confirm(msg, function(e){
        if (e) {
          $('.delete-form').submit();
        } else {
          alertify.log("Bade deletion canceled.")
        }
      });
    });























